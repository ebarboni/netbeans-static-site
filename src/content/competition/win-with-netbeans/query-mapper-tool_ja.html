<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>NetBeans コンテスト向けのクエリーマッパーチュートリアル</title>
<META NAME="description" CONTENT="Query Mapper Tool">
<META NAME="AUDIENCE" CONTENT="NBUSER">
<META NAME="TYPE" CONTENT="ARTICLE">
<META NAME="TOPIC" CONTENT="BASIC">
<link rel="stylesheet" type="text/css" href="../../netbeans.css">
</head>
<body >
<h1>クエリーマッパーツール</h1>
<div class="articledate" style="margin-left:0px;"><a href="../../competition/win-with-netbeans.html">Win With NetBeans</a> コンペティションの一部として Zsolt Kiss 氏から寄稿</div></p>
<p><a href="https://netbeans.org/projects/www/downloads?action=download&dlID=478">ファイルとソースのダウンロード</a></p>
<div id="contentLeft">
<table >
  <tbody>
    <tr>

      <td>
      <p>筆者は Web プログラマとして、プロジェクトのリソースが管理不能な状態に陥ってしまうという問題に、頻繁に直面しました。ついに、ソースファイルを調べ、それらを関連するほかのリソースに対応付けることができる、気のきいた小さなツールを作成することにしました。 </p>
      <p>堅牢なデータベース駆動アプリケーションを開発する場合、次のようにキー = 値ペアの形式でデータベース文を単一のプロパティーファイル内に格納するのは、おそらく良い考えです。 </p>
      <pre class="examplecode">		sql.t_machine.insert=insert into t_machine (id, mcname, headnum) values (?,?,?)<br>	</pre>
この形式を使用する際にすべきことは、プロパティーファイルを Java コードに読み込むことだけであり、それにより、PreparedStatement オブジェクトインスタンスを構築したり、HTML フォームから受け取った値を使用して必要なパラメータ化を行なったりするのが楽になります。
      <pre class="examplecode">		Properties props = new Properties();<br>		FileInputStream in = new FileInputStream(&quot;./query.properties&quot;);<br>		props.load(in);<br>		....<br>		Connection con = DriverManager.getConnection(dbURL);<br>		String sqlUpdate = props.getProperty(&quot;sql.employees.update&quot;);<br>		PreparedStatement pstm = con.preparedStatement(sqlUpdate);<br>		pstm.setString(1, &quot;Jacob&quot;);		// 名フィールドを更新します<br>		pstm.setString(2, &quot;Nielsen&quot;);		// 姓フィールドを更新します<br>		pstm.setInt(3, 47);			// 更新文の「WHERE」節のレコード ID を設定します<br>	</pre>

      <p>ここまでは問題ありませんが、もしプロパティーファイルに数百の文が含まれていて、さらにその一部が複数の Java クラスで使用されていたとしたら、どうでしょうか。もし皆さんや同じプロジェクトで作業しているほかのだれかが、何か (SQL 文が依存するパラメータの数や順番など) を変更したとしたら、その変更に従うために、その文に関係するすべての Java クラス、JSP、および HTML ページを把握するべきです。 </p>
      <p>データベースプログラマの存在や、彼らが、Java 開発者がコーヒーを飲みに行くのと同じくらいの頻度で表やクエリーを変更する必要があることは、だれでも知っています。常に変化し続ける顧客のニーズについては言うまでもありません。したがって、プロパティーファイルは間違いなく静的なものになりません。SQL 文が変更されるたびにコードも変更する必要があります。そのうちに、プロパティーファイルの各文と、その処理やパラメータ化を行う Java クラスとの照合を、1 件ずつ行う必要性に迫られます。 </p>
      <p>なぜ気のきいた便利な QueryMapping ツールが必要なのかを、皆さんも理解し始めたことと思います。 </p>
      <p>それでは、筆者の説明に耳を傾けてください。 </p>
      <p>挿入文、更新文、および選択文をデータベースに送信するフォームをユーザーに提供する JSP が数個しか含まれていない小さなサンプル Web アプリケーションがあるとします。ユーザーがページを要求 (通常はリンク、アイコン、メニューバー要素などをクリック) すると、バックグラウンドで多くのことが発生する可能性があります。たとえば、次に表示する画面上のリストや表を生成するデータベース選択文などです。ユーザーがページ上での作業を完了 (通常はフォーム要素に何らかのデータを入力) して送信をクリックすると、新しい要求が Web サーバーに送信されます。そしてふたたび、いずれかの Java クラスが何らかのデータベース操作を行う可能性があります。 </p>
      <p>想像しやすいように、非常に単純な Web GUI を次に示します。 </p>

      <p> <img src="../../images_www/articles/win-with-netbeans/pic2.gif"  hspace="15" vspace="15"></p><p>左側の (赤色で強調表示された)「Newly Ones' Blackboard」メニュー項目をユーザーがクリックすると、その回答ページが右側に表示されました。右側のフレームの上側の表とそのデータは、データベース操作によって生成されました。ここでユーザーは、データの書き換え対象となるレコードを、リストから 1 つ選択できます。完了したら、「Record」ボタンをクリックしてデータベースにデータを保存します。<br>
バックグラウンドでのデータベース作業を伴う表示対象ページがアプリケーションに多数含まれていると、ある時点で開発プロセス全体が管理不可能になることが、容易に理解できます。1 つか 2 つの文やファイルに対して何らかの変更を加える場合は、GUI やメニュー項目、JSP、HTML ページや Java コード、および関連する SQL 文の間の何らかの相互参照が必要となります。 </p>
      </td>
    </tr>
    <tr>
      <td height="20">&nbsp;</td>
    </tr>

    <tr>
      <td>
      <h2>ツール</h2>
      <p>クエリーマッパーツールでは、1 つの JFrame 上に 4 つのビューが存在し、ビューごとにタブを 1 つずつ含む JTabbedPane が含まれています。タブは順に次のとおりです。 </p>
      <ul>
        <li>アプリケーションビュー</li>
        <li>プロパティービュー </li>

        <li>コードビュー </li>
        <li>表ビュー </li>
      </ul>
</p>
<p>
<img src="../../images_www/articles/win-with-netbeans/appview.gif"  hspace="15" vspace="15" width="" height=""></p><p>
<b>アプリケーションビュー</b>には、アプリケーションの何らかの論理的な順番が含まれる可能性があります。筆者の場合はメニュー階層を選択しましたが、それはプログラマの選択になります。アプリケーションのメニューマップに基づいて何かを調べている場合や、ある機能をここでしか見つけられない場合には、アプリケーションビューから使い始めてください。ご覧のように、アプリケーションビューのレベル 1 のノードは、前述の「Two Storks Fly &amp; Drive」サンプルアプリケーションのメニュー構造に一致しています。いずれかのノードをクリックすると、on request page と on submit form という 2 種類のサブノードが表示されます。これらによって、SQL 文を 2 つのグループに分割できます。1 つは、<i>レンダリングの前に実行</i>され、次回のページ上にその結果が表示されるもの、もう 1 つは、フォームの<i>送信後に実行</i>されるものです。ツリーのリーフは、プロパティーファイルに含まれる SQL プロパティー文字列です。開発者はこのビューの全体から、特定の文がアプリケーションのどの部分で呼び出され、どのユーザー相互作用 (ページ要求またはフォーム送信) によってそのクエリーが実行されたかを把握できます。

</p>
<br clear="all">
<p>
<b>プロパティービュー</b>には、プロパティーファイルに含まれる SQL 文のキーが表示されるほか、Java コードが使用するキーも表示されます。</p>
<p><img src="../../images_www/articles/win-with-netbeans/propview.gif"  hspace="15" vspace="15" width="" height=""></p>
<p>
ここでノードを展開すると、関連する論理エントリ (ある機能を起動するためにユーザーがクリックするメニューバー内の名前) が表示されます。そして、さらに下のレベルには、その特定の文に関係する 3 種類のソースファイルが存在します。3 種類とは次のとおりです。
<ul>
	<li>データソース</li>
	<li>セッター</li>
	<li>プロセッサ</li>

</ul>

<b>データソース</b>は、任意の HTML や JSP、さらにはサーブレット (サーブレットが「名前なし」を生成する場合はダイナミック HTML) として表現できます。データソースは通常、文に埋め込む値の提供元となるファイル (ページ)、つまりサーバー側に送信される値をユーザーが入力できる場所となるファイル (ページ) です。データソースが 1 つも存在しないことも、珍しくありません (たとえば、WHERE 節が 1 つも含まれない「SELECT」文では、入力などは一切不要となります)。<br><br>
筆者の用語では、<b>セッター</b>とは、ユーザーフォーム (データソース) から受け取った値を処理する Java または JSP ファイルのことです。セッターでは、検証も行われる可能性はありますが、PreparedStatement の疑問符のユーザー入力への<i>置き換えは毎回</i>行われます。<br><br>
そして最後の、しかし決して軽んじてはならない<b>プロセッサ</b>は、特定の文を処理する Java クラス (JSP ページでも可) です。これらには、<i>executeQuery()、executeUpdate()、executeBatch() など</i>のメソッド呼び出しが含まれます。

</p>
<br clear="all">
<p>
<b>コードビュー</b>には、ファイルタイプ別にグループ化されたアプリケーションの完全なファイル一覧が表示されます。すべてのファイル名の下には、関連する文を含んだ展開可能なノードがあります。
</p><p>
<img src="../../images_www/articles/win-with-netbeans/codeview.gif"  hspace="15" vspace="15" width="" height=""></p><p>
アプリケーションビューから開始してあるメニュー項目をクリックしたあと、そのメニューに関係する SQL 文を 1 つ選択し、それからプロパティービューに移動した場合、その選択した文が強調表示されて表示されます。その子を展開してリソースファイルを 1 つ選択し、それをクリックしてからコードビューに変更します。するとコードビューでは、その選択したリソースとこのリソースに影響を与えるすべての文が表示されます。複数のビューを切り替えることで、興味のある情報を絞り込んだり、開発者の視点からプロジェクトの構造を調べたりすることが可能となります。
</p>
<br clear="all">
<p>
<img src="../../images_www/articles/win-with-netbeans/tableview.gif"  hspace="15" vspace="15" width="" height=""></p><p>
プロパティーファイルのキーの背後にある<i>実際の SQL 文</i>を確認できないとしたら、すべてが何の価値もなくなります。それが、<b>表ビュー</b>の存在理由です。表ビューには、アプリケーションのすべての SQL 文が、表名別にグループ化されて表示されます。もちろんここでも、主要な参照はプロパティーキーになりますが、それをクリックすると実際の文が表示されます。

</p>
<br clear="all">
<p>
このあとも読み続ける読者には、<span style="color:red;font.weight:bold;">NetBeans 4.0</span> でこのアプリケーションを開発した際のプロセスについて、詳しく解説します。
</p>

	</td>
    </tr>
    <tr>
	<td>
<p>ここでは次のトピックについて説明します。

</p>
<ul>
  <li><a href="#setup">NetBeans IDE 4.0 での新しいアプリケーションの設定</a></li>
  <li><a href="#createxml">プロジェクトの XML ファイルやプロパティーファイルの作成</a></li>
  <li><a href="#javaclasses">Java クラスの作成</a></li>
  <li><a href="#compileandrun">プロジェクトをコンパイルして実行する</a></li>
  <li><a href="#runwithargs">コマンド行引数を指定してプロジェクトを実行する方法</a></li>

 </ul>
<p>
<h2><a name="setup"></a>NetBeans IDE 4.0 での新しいアプリケーションの設定</h2>

<ol>
	<li>
<p>
「ファイル」&gt;「新規プロジェクト」&gt;「一般」&gt;「Java アプリケーション」を選択し、「次へ」をクリックします。
</p>
	</li>
	<li>
<p>

プロジェクト名: QueryMapperTool。NetBeans にプロジェクトフォルダを配置させたい場所を参照します。チェックボックス「主プロジェクトとして設定」と「主クラスを作成」がオンになっていることを確認します。主クラスの名前を、好みのフルパッケージ名付きで入力します。筆者は com.zsoltkiss.qmt.QueryMapper を使用しました。この場合、選択するのは皆さんです。「完了」をクリックすると、NetBeans によって、指定されたパス上にプロジェクトフォルダが自動的に作成されます。IDE で「プロジェクト」ビューと「ファイル」ビューがアクティブになるようにしてください。Ctrl+1 キーと Ctrl+2 キーを押します。これらのビューを使うと、プロジェクトのファイル、パッケージの構造、クラスなどをいつでもチェックできます。
</p>
	</li>
	<li>
<p>
このアプリケーションでは JDOM API が使用されています。これは <a href="http://www.jdom.org">http://www.jdom.org</a> からダウンロードできます。
</p>
	</li>
<p>
JDOM API をダウンロードしたら、それに関する情報と、それがプロジェクトで必要になることを、NetBeans に知らせる必要があります。IDE で「プロジェクト」タブをクリックし (非表示になっている場合は Ctrl+1 キーを押し)、プロジェクトの名前を右クリックして「プロパティー」を選択します。「構築」セクションで「ソースのコンパイル」を選択します。「JAR/フォルダを追加」をクリックします。ここで、JDOM をインストールしたフォルダを NetBeans に示す必要があります。JDOM インストールディレクトリの下の build サブフォルダで jdom.jar をクリックし、「開く」を選択します。他社製やユーザー独自の.jar ファイルをプロジェクトのリソースに追加する場合は必ず、この手順に従う必要があります。
</p>
	</li>

	<li>
<p>
いくつかの .gif ファイル、1 つのプロパティーファイル、1 つの XML ファイルも必要です。GIF は、JTree オブジェクトでリーフアイコンとして使用されます。独自のものを作成してもかまいませんし、このチュートリアルに付属しているものを使用してもかまいません。NetBeans では、後述するように、XML ファイルやプロパティーファイルを非常に簡単に作成できます。これらのファイルが手元にある場合は、それをプロジェクトフォルダ内にコピーします。コピー後に、プロジェクトの「ファイル」ビューにそれらが存在するか確認してください。
</p>
	</li>

</ol>
</p>
<h2><a name="createxml"></a>プロジェクトの XML ファイルやプロパティーファイルの作成</h2>

<ol>
	<li>
<p>

IDE の「プロジェクト」タブでプロジェクトの名前を右クリックし、「新規」&gt;「ファイル/フォルダ」を選択します。「カテゴリ」で「XML」を選択し、ファイルの種類として「XML ドキュメント」をクリックします。「次へ」をクリックします。ファイル名として querymapping と入力し、場所は空のままにします。したがって、プロジェクトフォルダのすぐ下にファイルが配置されます。「次へ」をクリックします。「ドキュメントの種類を選択」ページでは、「整形式のドキュメント」をオンのままにします。「完了」をクリックします。
</p>
	</li>
	<li>
<p>
すべてうまくいった場合は、XML ドキュメントがエディタのフレーム内に表示されます。このドキュメントは、アプリケーションにとって重要です。編集時には細心の注意を払ってください。まず、ルート要素を次のように変更します。 <pre>&lt;query-mapping&gt;</pre> 簡単にするために、このチュートリアルに付属する XML を使用してもかまいません。そのほんの一部を次に示します。
<pre class="examplecode">
&lt;query-mapping&gt;
	&lt;query name=&quot;sql.crosstable.afterdate&quot; desc=&quot;Select users entered after a specified date&quot;&gt;

		&lt;app-section name=&quot;Newly Ones' Blackboard&quot; call=&quot;on-submit-form&quot;&gt;
                    	&lt;datasource src=&quot;Parameterizer.java&quot; /&gt;
                    	&lt;setter src=&quot;DoQuery.java&quot; /&gt;
                    	&lt;processor src=&quot;DoQuery.java&quot; /&gt;
                &lt;/app-section&gt;
 	&lt;/query&gt;

		...

	</pre>
編集時には忘れずに、保存をときどき行ってください。この XML ドキュメントでは、アプリケーションのセクションつまりメニューの構造と、SQL 文、Java、JSP、および HTML ファイルとのその接続とが記述されます。これについて少し調べてみてください。名前を見れば説明は不要なはずです。
</p>
	</li>
	<li>
<p>
次に、SQL 文を象徴的なプロパティー名に対応づけるためのプロパティーファイルを作成します。このチュートリアルに付属するものを使用してもかまいません。「プロジェクト」タブでプロジェクトの名前を右クリックして「新規」、「ファイル/フォルダ」をクリックし、「カテゴリ」で「その他」をクリックし、ファイルの種類として「プロパティーファイル」を選択します。「次へ」をクリックします。ファイル名として query と入力し、「フォルダ」入力ボックスは空のままにします。「完了」をクリックします。プロジェクトフォルダのすぐ下にプロパティーファイルが作成されます。IDE の「ファイル」ビューで、その名前をダブルクリックして編集を開始できます。デフォルト言語を右クリックしてから「プロパティーを追加」を選択します。表示されるポップアップで、SQL 文の必要なキーと値のペアを作成できます。ときどき忘れずに作業を保存するようにしてください。
</p>
	</li>

</ol>
<a name="javaclasses">Java クラスの作成</a>


<ol>
	<li>
<p>
既存のソースファイルをプロジェクトに追加する選択肢が用意されています。コードをより深く理解したい場合は、このチュートリアルに付属するソースを使用できます。この場合は単純に、必要なファイルをその格納元のディレクトリとともに、プロジェクトの src フォルダの下にコピーします。ただし、パッケージとそのディレクトリ構造が一致するように注意してください。新しいクラスを作成するための、より安全で洗練された方法は、プロジェクトの名前をダブルクリックして「新規」&gt;「ファイル/フォルダ」を選択したあと、カテゴリとファイルの種類の両方で「Java クラス」をクリックすることです。この画面では毎回、クラスを新しいパッケージの下に作成することを選択できます。このプロジェクトでは、com.zsoltkiss.qmt と com.zsoltkiss.qmt.util という、独自に定義された 2 つのパッケージを使用します。これらの階層に対応するフォルダ構造は必ず、プロジェクトの src フォルダの下に作成されます。
</p>
	</li>
	<li>
<p>
必要なクラスを作成します。ソースコードを入力することも、このチュートリアルに付属するソースからコードをコピー＆ペーストすることもできます。
</p>
	</li>

</ol>
<h2><a name="compileandrun"></a>プロジェクトをコンパイルして実行する</h2>

<ol>
	<li>
<p>
もっともすばやくコンパイルする方法は、筆者の場合は「生成物を削除して構築」であり、Shift+F11 キーを常に使用します。これは、開発者によって異なります。タイピングよりもマウス操作を好むユーザーは、IDE のメニューバーで、「生成物を削除して構築」アイコンをクリックするか「構築」メニューを開くことで、その機能を起動してください。IDE のコンパイル時のメッセージは出力ウィンドウで確認できますが、このウィンドウが非表示になっている場合は、Ctrl+4 キーでいつでもアクティブにすることができます。
</p>
	</li>
	<li>
<p>
コンパイルと構築が成功したら、F6 キーでプロジェクトを実行できますが、もちろん、対応するアイコンをクリックしたり、「実行」メニューから選択したりしてもかまいません。
</p>

	</li>

</ol>
<h2><a name="runwithargs"></a>コマンド行引数を指定してプロジェクトを実行する方法</h2>
<ol>
	<li>
<p>
プロジェクトの独自のフォルダ内に存在するプロパティーファイルや XML ファイルを使用するのが、常に良い方法であるとはかぎりません。別のパスにファイルが存在する場合は、プロジェクトの主クラスを実行する際にコマンド行パラメータを指定する必要があります。ぜひテストしてみてください。query.properties または querymapping.xml、あるいはその両方をプロジェクトのフォルダから削除し、アプリケーションの実行を試みてください。成功しなかったと思います。
</p>
	</li>
	<li>
<p>
次に、先ほど削除したファイルを、ハードドライブ上の任意の場所にある、プロジェクトのフォルダ以外のディレクトリ内に配置します。NetBeans IDE の「プロジェクト」ウィンドウでプロジェクトの名前を右クリックし、「プロパティー」、「プロジェクトの実行」を順に選択します。ウィンドウの右側の区画の「引数」に、プロパティーファイルと XML ファイルの移動先となったディレクトリの適切なパスを入力します。まずプロパティーファイルのパスを入力し、次に空白を入力し、最後に XML ファイルのパスを入力します。「了解」をクリックし、F6 キーでプロジェクトを実行します。これで成功するはずです。
</p>
	</li>
</ol>
</td>
    </tr>
    <tr>
	<td>
皆さんが、前述の手順に従ってクエリーマッパーツールアプリケーションの構築に成功し、このツールで少し遊び始めているとしたら、幸いです。完全なコメントの付いたコードを記述するように心がけたので、ここではその詳細に立ち入りません。このツールを利用するとその使用方法を容易に理解でき、必要に応じてプロパティーファイルや XML ファイルを使用してユーザー独自のバージョンを開発できます。ユーザーは常にアプリケーションを改善できるので、ここではアイデアのみを提示しておきたいと思います。可能性は本当に無限にあります。たとえば、ほんのわずかな労力で、これにエディタを組み合わせ、そのエディタから編集対象のファイルをユーザーが直接開けるようにすることも可能です。<br>  いずれにせよ、問題は依然として存在します。筆者は毎日問題に直面しています。堅牢で快適なツールを記述してこれを解決することは、おそらく時間をかけるだけの価値が本当にあります。あるいは、この種のツールを NetBeans に組み込みますか。<br><br></td>
    </tr>
  </tbody>

</table>
</div>
</body>
</html>